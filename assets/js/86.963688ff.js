(window.webpackJsonp=window.webpackJsonp||[]).push([[86],{425:function(a,s,t){"use strict";t.r(s);var e=t(0),n=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h3",{attrs:{id:"prometheus相关实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prometheus相关实践"}},[a._v("#")]),a._v(" prometheus相关实践")]),a._v(" "),s("h4",{attrs:{id:"docker部署prometheus和grafana"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker部署prometheus和grafana"}},[a._v("#")]),a._v(" docker部署prometheus和grafana")]),a._v(" "),s("h5",{attrs:{id:"启动node-exporter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动node-exporter"}},[a._v("#")]),a._v(" 启动node-exporter")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9100")]),a._v(":9100 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" node-exporter "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/node-exporter-data/proc:/host/proc:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/node-exporter-data/sys:/host/sys:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/node-exporter-data:/rootfs:ro "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n prom/node-exporter\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),a._v(" "),s("h5",{attrs:{id:"编写prometheus-yml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写prometheus-yml"}},[a._v("#")]),a._v(" 编写prometheus.yml")]),a._v(" "),s("div",{staticClass:"language-yml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("global")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("scrape_interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 60s\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("evaluation_interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 60s\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("scrape_configs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("job_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prometheus\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("static_configs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" 192.168.0.104"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9090")]),a._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("job_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("exporter\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("static_configs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" 192.168.0.104"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9100")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("job_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" jenkins\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("scheme")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" http\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metrics_path")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" prometheus\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("bearer_token")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" bearer_token\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("static_configs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("targets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" 192.168.57.242"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("8080")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br")])]),s("h5",{attrs:{id:"启动promethus"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动promethus"}},[a._v("#")]),a._v(" 启动promethus")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" prometheus "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-u")]),a._v(" root "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9090")]),a._v(":9090 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/prometheus-data/prometheus.yml:/etc/prometheus/prometheus.yml "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/prometheus-data:/prometheus "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/prometheus-data/conf:/etc/prometheus/conf "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n prom/prometheus --web.enable-lifecycle\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br")])]),s("h5",{attrs:{id:"启动grafana"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动grafana"}},[a._v("#")]),a._v(" 启动grafana")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),a._v(":3000 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("grafana "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-u")]),a._v(" root "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/apps/docker/grafana-data:/var/lib/grafana "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n grafana/grafana\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("p",[a._v("grafana账号密码默认admin")]),a._v(" "),s("h4",{attrs:{id:"metric指标"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#metric指标"}},[a._v("#")]),a._v(" Metric指标")]),a._v(" "),s("h5",{attrs:{id:"数据模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据模型"}},[a._v("#")]),a._v(" 数据模型")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://pic.fengyuwusong.cn/20220512151720.png",alt:"数据模型"}})]),a._v(" "),s("p",[a._v("Prometheus 采集的所有指标都是以时间序列的形式进行存储，每一个时间序列有三部分组成：")]),a._v(" "),s("ul",[s("li",[a._v("指标名和指标标签集合：metric_name{<label1=v1>,<label2=v2>....}，指标名：表示这个指标是监控哪一方面的状态，比如 http_request_total 表示：请求数量；指标标签，描述这个指标有哪些维度，比如 http_request_total 这个指标，有请求状态码 code = 200/400/500，请求方式：method = get/post 等，实际上指标名称实际上是以标签的形式保存，这个标签是name，即：name=。")]),a._v(" "),s("li",[a._v("时间戳：描述当前时间序列的时间，单位：毫秒。")]),a._v(" "),s("li",[a._v("样本值：当前监控指标的具体数值，比如 http_request_total 的值就是请求数是多少。")])]),a._v(" "),s("h5",{attrs:{id:"指标类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#指标类型"}},[a._v("#")]),a._v(" 指标类型")]),a._v(" "),s("ul",[s("li",[a._v("Counter 计数器")]),a._v(" "),s("li",[a._v("Gauge 仪表盘")]),a._v(" "),s("li",[a._v("Histogram 直方图")]),a._v(" "),s("li",[a._v("Summary 摘要")])]),a._v(" "),s("h4",{attrs:{id:"promql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#promql"}},[a._v("#")]),a._v(" PromQL")]),a._v(" "),s("p",[a._v("PromQL 是 Prometheus 为我们提供的函数式的查询语言，查询表达式有四种类型：")]),a._v(" "),s("ul",[s("li",[a._v("字符串：只作为某些内置函数的参数出现")]),a._v(" "),s("li",[a._v("标量：单一的数字值，可以是函数参数，也可以是函数的返回结果")]),a._v(" "),s("li",[a._v("瞬时向量：某一时刻的时序数据")]),a._v(" "),s("li",[a._v("区间向量：某一时间区间内的时序数据集合")])]),a._v(" "),s("h5",{attrs:{id:"瞬时查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#瞬时查询"}},[a._v("#")]),a._v(" 瞬时查询")]),a._v(" "),s("p",[a._v("直接通过指标名即可进行查询，查询结果是当前指标最新的时间序列，比如查询 Gc 累积消耗的时间：")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 直接查询")]),a._v("\ngo_gc_duration_seconds_count\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 筛选")]),a._v("\ngo_gc_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("instance"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"127.0.0.1:9600"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 正则")]),a._v("\ngo_gc_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("instance"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=~")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"localhost.*"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("h5",{attrs:{id:"范围查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#范围查询"}},[a._v("#")]),a._v(" 范围查询")]),a._v(" "),s("p",[a._v("范围查询的结果集就是区间向量，可以通过[]指定时间来做范围查询，查询 5 分钟内的 Gc 累积消耗时间：")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# d：天，h：小时，m：分钟，ms：毫秒，s：秒，w：周，y：年")]),a._v("\ngo_gc_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 偏移")]),a._v("\ngo_gc_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" offset 1d\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h5",{attrs:{id:"内置函数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内置函数"}},[a._v("#")]),a._v(" 内置函数")]),a._v(" "),s("h6",{attrs:{id:"rate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rate"}},[a._v("#")]),a._v(" rate")]),a._v(" "),s("p",[a._v("rate 函数可以用来求指标的平均变化速率")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("rate函数"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("时间区间前后两个点的差 / 时间范围\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("一般 rate 函数可以用来求某个时间区间内的请求速率，也就是我们常说的 QPS：")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("rate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("demo_api_request_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("1m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("/60\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("但是 rate 函数只是算出来了某个时间区间内的平均速率，没办法反映突发变化，假设在一分钟的时间区间里，前 50 秒的请求量都是 0 到 10 左右，但是最后 10 秒的请求量暴增到 100 以上，这时候算出来的值可能无法很好的反映这个峰值变化。这个问题可以通过 irate 函数解决，irate 函数求出来的就是瞬时变化率。")]),a._v(" "),s("h6",{attrs:{id:"irate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#irate"}},[a._v("#")]),a._v(" irate")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("irate "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" 时间区间内最后两个样本点的差 / 最后两个样本点的时间差\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h6",{attrs:{id:"聚合函数-sum-by-without"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#聚合函数-sum-by-without"}},[a._v("#")]),a._v(" 聚合函数：Sum() by() without()")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 将多个服务多个接口的请求聚合")]),a._v("\nsum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("rate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("demo_api_request_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("job"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"demo"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("method")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"GET"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("status")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"200"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("))")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 根据请求接口标签分组")]),a._v("\nsum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("rate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("demo_api_request_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("job"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"demo"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("method")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"GET"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("status")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"200"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("))")]),a._v(" by"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 不根据接口路径分组")]),a._v("\nsum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("rate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("demo_api_request_duration_seconds_count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("job"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"demo"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("method")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"GET"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("status")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"200"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("))")]),a._v(" without"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("h6",{attrs:{id:"histogram-quantile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#histogram-quantile"}},[a._v("#")]),a._v(" histogram_quantile")]),a._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 用来统计百分位数：第一个参数是百分位，第二个 histogram 指标，这样计算出来的就是中位数，即 P50")]),a._v("\nhistogram_quantile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.5")]),a._v(",go_gc_pauses_seconds_total_bucket"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h5",{attrs:{id:"其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[a._v("#")]),a._v(" 其他")]),a._v(" "),s("h6",{attrs:{id:"prometheus配置动态动态更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prometheus配置动态动态更新"}},[a._v("#")]),a._v(" prometheus配置动态动态更新")]),a._v(" "),s("ul",[s("li",[a._v("启动时需带上参数 "),s("code",[a._v("prometheus --config.file=/usr/local/etc/prometheus.yml --web.enable-lifecycle")])]),a._v(" "),s("li",[a._v("更新prometheus.yml配置")]),a._v(" "),s("li",[a._v("通过post的方式请求接口"),s("code",[a._v("curl -v --request POST 'http://localhost:9090/-/reload'")])])]),a._v(" "),s("h6",{attrs:{id:"指标抓取和存储"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#指标抓取和存储"}},[a._v("#")]),a._v(" 指标抓取和存储")]),a._v(" "),s("p",[a._v("Prometheus 对指标的抓取采取主动 Pull 的方式，即周期性的请求被监控服务暴露的 metrics 接口或者是 PushGateway，从而获取到 Metrics 指标，默认时间是 15s 抓取一次，配置项如下：")]),a._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("global")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("scrape_interval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 15s\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("抓取到的指标会被以时间序列的形式保存在内存中，并且定时刷到磁盘上，默认是两个小时回刷一次。并且为了防止 Prometheus 发生崩溃或重启时能够恢复数据，Prometheus 也提供了类似 MySQL 中 binlog 一样的预写日志，当 Prometheus 崩溃重启时，会读这个预写日志来恢复数据。")]),a._v(" "),s("h6",{attrs:{id:"prometheus分位数坑点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prometheus分位数坑点"}},[a._v("#")]),a._v(" prometheus分位数坑点")]),a._v(" "),s("p",[a._v("Prometheus 不保存具体的指标数值的，他会帮你把指标放到具体的桶，但是他不会保存你指标的值，计算的分位数是一个预估的值，怎么预估呢？就是假设每个桶内的样本分布是均匀的，线性分布来计算的。\n假设我们指定桶为："),s("code",[a._v("[]float64{0,2.5,5,7.5,10}")]),a._v("\n则 P50，其实就是算排在第50%位置的样本值，假设刚刚所有的数据都落在了第一个桶，那么他在计算的时候就会假定这个50%值在第一个桶的中点，他就会假定这个数就是 "),s("code",[a._v("0.5*2.5")]),a._v("，P99 就是第一个桶的 99%的位置，他就会假定这个数就是 "),s("code",[a._v("0.99*2.5")]),a._v("。")]),a._v(" "),s("p",[a._v("导致这个误差较大的原因就是我们的 bucket 设置的不合理。")]),a._v(" "),s("h4",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[a._v("#")]),a._v(" 参考")]),a._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://mp.weixin.qq.com/s/sQpB0WTs7eBDi4BuWp7gQg",target:"_blank",rel:"noopener noreferrer"}},[a._v("一文带你了解 Prometheus"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);